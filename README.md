# Fitting-Piecewise-Linear-Continuous
Approximate time-position trajectory by continuous piecewise linear function and find breakpoints and slopes.
Supplementary Information


Segmentation analysis of extracted transcription trajectories

Structure of the data
A condition is specified by the composition of the elongation complex. In this study, we tested 14 different conditions which correspond to different subsets of the 8 elongation factors (not exhaustive). We refer to each condition by the variable c = 1,2,…,14. For example, the elongation complex with all factors is c = 1; the elongation complex without TFIIS is c = 2; the elongation complex without IWS1 is c = 3, and so on. In an Excel data file, each condition has its own sheet.
For each elongation complex c, we have T(c) trajectories. Different conditions c may have different numbers of trajectories T(c). In condition c, each trajectory t = 1, 2, …, T(c) consists of a pair of column vectors (S(c,t), K(c,t)) which are of the same length L(c,t). The length L(c,t) measures the number of recorded observations of trajectory t in condition c in S(c,t) and also in K(c,t). These vectors appear in adjacent vertical columns in an Excel spreadsheet. The first row of each sheet gives a unique alphanumeric identifier for each trajectory. S is a mnemonic for “seconds.” K is a mnemonic for “kilobases.” For trajectory t in condition c, the jth element of S(c,t), which we label S(c,t,j), is the time at which the jth observation is recorded, and j = 1, 2, …, L(c,t). Time is measured in seconds from the beginning of a trajectory. The corresponding jth element K(c,t,j) of K(c,t) is the transcription length at time S(c,t,j). Transcription length is measured in kilobases.
Each trajectory is segmented separately. We simplify the notation used to describe how a trajectory is segmented: assume a fixed condition c and a fixed trajectory t in condition c. We describe the segmentation analysis as applied to one pair of vectors (S, K) each of length L. For j = 1, 2, …, L, the jth time of observation is S(j) and the transcription length at time S(j) is K(j). The goal of the following analysis is to approximate the plot of K as a function of S by a sequence of linear segments (Fig. 1C and Extended Data Fig. 3) which may have slope 0 (horizontal segment) or may have a positive slope (as transcription proceeds) or a negative slope (as transcription is reversed or backtracking of Pol II). Each segment is separated from its preceding segment (if any) and from its following segment (if any) by a change point, a time at which the estimated slope changes.

MATLAB software_ ‘FitPiecewiseLinearContinuous.m’
Our code is written in Matlab (Mathworks R2023b). The user chooses several parameters that govern the software. These parameters are explained below.
	readmat = 0 means read the data from an Excel spreadsheet; readmat = 1 means read data from a .mat file where it was stored previously;
	Nsheets = C is the number of conditions;
	globalmaxchangepoints = 15 limits maximum number of changepoints (NCP);
	mintimegap = 3 seconds sets minimal time (s) between changepoints; if two changepoints are initially estimated within 'mintimegap', they are replaced by one changepoint at the midpoint;
	δ=10^(-6), the width of the interval of random perturbations of the recorded times, to break ties.
When the data are read from an Excel file, the user must specify which columns house data. For each condition (Excel sheet) c, our software calculates the number T(c) of trajectories from the number of columns that house data. When the data are read from a .mat file, the saved variables are:
	Nsheets = C, the number of sheets or conditions;
	sheetnames, a list of alphanumeric names for each condition;
	Ntrajectories = T = (T(1), … ,T(C)), a vector of the number T(c) of trajectories in each condition c, for c = 1, 2, …, C;
	outnum, all the numerical values in each sheet;
	outtxt, all the alphanumeric column headings, which are the names of the individual trajectories;
	sheetnames, stringsheetnames, two formats for the names of the sheets or conditions;
	time = S(c,t,j), a cell array of the time observations in condition c for trajectory t for j = 1, …, L(c,t), where L(c,t) is the number of observations in condition c for trajectory t;
	bp = K(c,t,j), a cell array of the observations of transcription length at each time in condition c for trajectory t for j = 1, …, L(c,t), where L(c,t) is the number of observations in condition c for trajectory t;
	trajectorynames, a cell array of length c (one cell for each condition) of the names of the individual trajectories, taken from outtxt; the jth cell contains a vector of length T(c), each element of which is a string with the name of the corresponding trajectory.	
Sometimes the identical reported time will occur more than once. To break all such ties so that the observations occur in a unique order, we add to each time an independently chosen small random quantity uniformly distributed between -δ and +δ. We set δ=10^(-6) seconds; the user can change the value at will. After this random perturbation, the vectors S and K are sorted in increasing order of the (perturbed) time element in S.

Bayesian estimation of the number of changepoints
We used the Matlab version of Rbeast. Rbeast is available in Matlab, R, Python, and C. The source code and installation instructions are available at https://github.com/zhaokg/Rbeast. According to the website, “BEAST (Bayesian Estimator of Abrupt change, Seasonality, and Trend) is a fast, generic Bayesian model averaging algorithm to decompose time series or 1D [one-dimensional] sequential data into individual components, such as abrupt changes, trends, and periodic/seasonal variations.1 BEAST is useful for changepoint detection (e.g., breakpoints, structural breaks, joinpoints, regime shifts, or anomalies), trend analysis, time series decomposition (e.g., trend vs. seasonality), time series segmentation, and interrupted time series analysis.” The specific version we used is beast_irreg with parameters ‘deltat’,1,’season’,’none’.
Rbeast operates by estimating a probability (called q(1)) for the possibility that there is just one change point (without specifying the location of that change point). Then, conditional on one change point, Rbeast estimates a probability (called q(2) < q(1)) for the possibility that there is just one more change point. Then, conditional on two change points, Rbeast estimates a probability (called q(3) < q(2)) for the possibility that there is just one more change point (i.e., a total of three); and so on, possibly up to our chosen globalmaxchangepoints. We find the maximal number of change points, called MaxCP, such that the cumulative sum of the first MaxCP elements of q does not exceed 0.99.

Locating the change points for linear segments
With this number MaxCP of change points, we identify the times at which those change points occur using the Matlab function ischange with parameter ‘linear’. We approximate K as a piecewise (not necessarily continuous) linear function of the perturbed times while limiting the maximum number of changes to MaxCP (using 'MaxNumChanges',MaxCP). The ischange algorithm is based on Killick et al. (ref. 2). With the parameter ‘linear’, ischange fits straight lines to each segment between consecutive change points but the successive straight lines may not connect into one continuous trajectory. If the difference in seconds between two change points is less than our chosen value for the parameter mintimegap (3 s), then we replace the times at which both of those change points occur by a single time located at the arithmetic average of the original two times. This adjustment excludes any segments of duration less than mintimegap. We record the number of change points before and after this adjustment to the data as NchangepointsBefore and NchangepointsAfter, respectively.

Finding a continuous piecewise linear approximation
Given the (perturbed) times S and corresponding kilobase pairs transcribed K, and given the locations of the change points, we fit a continuous piecewise linear approximation to K using fitPiecewiseLinearFunctionGolovchenko.m written by Nikolai Golovchenko (2004) (https://www.golovchenko.org/home/pwl_fit). This code fits “a piecewise continuous [linear] function f(x) to the pairs of data points (x,y) such that the sum of squares of error is minimal.” It outputs x0, the values of x that define ends of segments of the fitted function f(x), and p, the end points of the linear segments, p = f(x0).

Tabulated results
A segment is defined by four numbers: its initial (perturbed) time S_0, its initial kb K_0, its final (perturbed) time S_1 and its final kb K_1. The duration of a segment is defined as S_1-S_0. The length of a segment is defined as K_1-K_0. The slope of a segment BpPerSecBetwCPs is defined as the ratio of length divided by duration, (K_1-K_0)/(S_1-S_0). We define a segment to belong to active transcription (slopeClass 1) if and only if its slope satisfies BpPerSecBetwCPs greater than or equal to 1 nt/s and its length exceeds 100 nt. Such a segment has progressing transcription. We define a segment to belong to pause (slopeClass 0) if and only if its slope is less than 1 nt/s. We tabulated the principal characteristics of all the segments of all the trajectories of all the conditions in a table with these columns: sheet (condition), trajectory (or trace) in that condition, segment number in that trajectory, start time for that segment, duration (seconds) of that segment, segment length (kbp), slope, and slopeClass. This table has one row for each segment. Further statistical analysis is based on this table.

Supplementary Information only references

1	Zhao, K. G. et al. Detecting change-point, trend, and seasonality in satellite time series data to track abrupt changes and nonlinear dynamics: A Bayesian ensemble algorithm. Remote Sens Environ 232 (2019). https://doi.org:ARTN1111810.1016/j.rse.2019.04.034
2	Killick, R., Fearnhead, P. & Eckley, I. A. Optimal Detection of Changepoints With a Linear Computational Cost. J Am Stat Assoc 107, 1590-1598 (2012). https://doi.org:10.1080/01621459.2012.737745

